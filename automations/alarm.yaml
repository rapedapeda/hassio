- id: alarm
  alias: Alarm
  description: 'State changes of the alarm'
  trigger:
    - platform: state
      entity_id: input_boolean.presence_status 
    - platform: sun
      event: sunset
      offset: "-00:45:00"
    - platform: sun
      event: sunrise
      offset: "+00:30:00"
  condition: []
  action:
    - service_template: >
        
        {% if states('input_boolean.presence_status') == 'off' %}
          alarm_control_panel.alarm_arm_away
        
        {% elif states('input_boolean.presence_status') == 'on' 
        and 
          (as_timestamp(states.sun.sun.attributes.next_setting) - as_timestamp(now())) | int < 2700 
        and
          (as_timestamp(now()) - as_timestamp(states.sun.sun.attributes.next_rising)) | int > 1800
        %}
          alarm_control_panel.alarm_disarm
        
        {% elif states('input_boolean.presence_status') == 'on' 
        and 
          (as_timestamp(states.sun.sun.attributes.next_setting) - as_timestamp(now())) | int > 2700 
        and
          (as_timestamp(now()) - as_timestamp(states.sun.sun.attributes.next_rising)) | int < 1800
        %}
        alarm_control_panel.alarm_arm_home          
        
        {% endif %}
      entity_id: alarm_control_panel.ha_alarm

# Eerste if is als er niemand is. Dan altijd armed_away
# Tweede is als er iemand is en het overdag is. Dan altijd disarm
# Derde is als er iemand is en het niet overdag is. Dan altijd armed_home

  # alarm_control_panel.alarm_disarm
  # alarm_control_panel.alarm_arm_away
  # alarm_control_panel.alarm_arm_home
  # {% if (as_timestamp(states.sun.sun.attributes.next_setting) - as_timestamp(now())) | int < 2700