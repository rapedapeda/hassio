- id: notificatie_batterijen
  alias: Batterijnotificatie
  trigger:
    - platform: time
      at: '18:00:00'
  condition:
    - condition: template
      value_template: >
        {% set ns = namespace(needed='false') %}
        {%- for entity_id in states.group.batteries.attributes.entity_id if states(entity_id)|int < 100 -%}
        {% set ns.needed = 'true' %}
        {%- endfor %}
        {{ ns.needed }}
  action:
    - service: persistent_notification.create
      data_template:
        title: Batterijstatus
        notification_id: low-battery-alert
        message: >
          "Vervang de batterij van de volgende apparaten: {%- for entity_id in states.group.batteries.attributes.entity_id if states(entity_id)|int == 100 -%} {{ state_attr(entity_id, 'friendly_name') }} ({{ states(entity_id) }}%){% if loop.last %}.{%- elif not loop.last %}, {% endif -%}{%- endfor %}"
    - service: notify.ramon
      data_template:
        title: "Batterijstatus"
        message: >
          "Vervang de batterij van de volgende apparaten: {%- for entity_id in states.group.batteries.attributes.entity_id if states(entity_id)|int == 100 -%} {{ state_attr(entity_id, 'friendly_name') }} ({{ states(entity_id) }}%){% if loop.last %}.{%- elif not loop.last %}, {% endif -%}{%- endfor %}"