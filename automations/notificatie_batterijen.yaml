- id: notificatie_batterijen
  alias: Batterijnotificatie
  trigger:
    - platform: time
      at: '18:00:00'
  condition:
    - condition: template
      value_template: >
        {%- for entity_id in states.group.batteries.attributes.entity_id -%}
        {% set parts = entity_id.split('.') -%}
        {%- if states(entity_id)|float < 90 %}
          {%- if loop.first %} {% elif loop.last %} en {% else %}, {% endif -%}{{ states[parts[0]][parts[1]].name }}{% endif -%}
        {%- endfor %}
  action:
    - service: persistent_notification.create
      data_template:
        title: Batterijstatus
        notification_id: low-battery-alert
        message: >
          {%- for entity_id in states.group.batteries.attributes.entity_id -%}
          {% set parts = entity_id.split('.') -%}
          {%- if states(entity_id)|float < 90 %}
            {%- if loop.first %} {% elif loop.last %} en {% else %}, {% endif -%}{{ states[parts[0]][parts[1]].name }}{% endif -%}
          {%- endfor %}
    - service: notify.ramon
      data_template:
        title: "Batterijstatus"
        message: >
          {%- for entity_id in states.group.batteries.attributes.entity_id -%}
          {% set parts = entity_id.split('.') -%}
          {%- if states(entity_id)|float < 90 %}
            {%- if loop.first %} {% elif loop.last %} en {% else %}, {% endif -%}{{ states[parts[0]][parts[1]].name }}{% endif -%}
          {%- endfor %}